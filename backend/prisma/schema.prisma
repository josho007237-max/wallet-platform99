generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  username     String?   @unique
  passwordHash String?
  role         String    @default("user")
  lineId       String?   @unique
  displayName  String?
  avatarUrl    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  WalletBalance WalletBalance?
  LedgerEntry   LedgerEntry[]
  RefreshToken  RefreshToken[]
  Transaction   Transaction[]
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])
}

model WalletBalance {
  id         Int       @id @default(autoincrement())
  userId     Int       @unique
  available  Float     @default(0)
  locked     Float     @default(0)
  updatedAt  DateTime  @updatedAt
  User       User      @relation(fields: [userId], references: [id])
}

model LedgerEntry {
  id             Int       @id @default(autoincrement())
  userId         Int
  txId           Int?
  type           String    // credit | debit | lock | unlock | adjust | transfer_in | transfer_out
  amount         Float
  balanceBefore  Float
  balanceAfter   Float
  lockedBefore   Float     @default(0)
  lockedAfter    Float     @default(0)
  currency       String    @default("THB")
  reference      String?
  idempotencyKey String?   @unique
  note           String?
  createdAt      DateTime  @default(now())
  User           User      @relation(fields: [userId], references: [id])
}

model Transaction {
  id          Int      @id @default(autoincrement())
  userId      Int
  channel     String?
  type        String   // deposit | withdraw | lost | refund
  amount      Float
  fee         Float    @default(0)
  status      String   // pending | matched | credited | failed | rejected | locked | approved | cancelled
  reference   String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User     @relation(fields: [userId], references: [id])
}

model BankAccount {
  id            Int      @id @default(autoincrement())
  bankCode      String
  accountNumber String
  accountName   String
  displayOrder  Int
  isActive      Boolean  @default(true)
  note          String?
  createdAt     DateTime @default(now())
}

model TrueMoneyWallet {
  id            Int      @id @default(autoincrement())
  phone         String
  accountName   String
  displayOrder  Int
  minDeposit    Float
  maxDeposit    Float
  qrSupport     Boolean  @default(true)
  endpointUrl   String
  secret        String
  isActive      Boolean  @default(true)
  note          String?
  createdAt     DateTime @default(now())
}

model Gateway {
  id                       Int       @id @default(autoincrement())
  name                     String
  apiKey                   String
  balance                  Float     @default(0)
  lastUpdated              DateTime?
  isActive                 Boolean   @default(true)
  maintenanceDepositStart  String?
  maintenanceDepositEnd    String?
  maintenanceWithdrawStart String?
  maintenanceWithdrawEnd   String?
  mobileConnected          Boolean   @default(false)
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  GatewayHistory           GatewayHistory[]
}

model GatewayHistory {
  id        Int      @id @default(autoincrement())
  gatewayId Int
  event     String
  meta      Json?
  createdAt DateTime @default(now())
  Gateway   Gateway  @relation(fields: [gatewayId], references: [id])
}

model WithdrawalSetting {
  id             Int      @id @default(autoincrement())
  minAmount      Float    @default(100)
  maxAmount      Float    @default(50000)
  dailyLimit     Float    @default(100000)
  fee            Float    @default(0)
  processingTime String   @default("1â€“3 minutes")
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model DepositSetting {
  id            Int      @id @default(autoincrement())
  minAmount     Float    @default(10)
  maxAmount     Float    @default(100000)
  dailyLimit    Float    @default(200000)
  allowChannels String   @default("bank,truemoney,promptpay,gateway")
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
